/::
custom_css: main.css
add_scripts: main.js
::/

# ğŸ‹ Simplifiez la conteneurisation de vos idÃ©es !

/*
- PrÃ©sentation: dev depuis 15 ans, galÃ¨re pour mettre en ligne
- Objectif: crÃ©er des images Docker pour envoyer vos projets en production en respectant les bonnes pratiques grÃ¢ce Ã  Dofigen

Next: dev => beaucoup de sujets Ã  traiter: tests, sÃ©curitÃ©, performance, etc.
*/

!include(intro.sdf)

//@ < 04:00

## DÃ©monstration .[steps]

Comprendre par l'exemple

### Objectifs

- ğŸª¶: Image lÃ©gÃ¨re
- ğŸš€: DÃ©marrage & rebuild rapide
- ğŸ›¡ï¸: Non-root & sans JDK

/*
Projet SpringBoot de base
133 dÃ©pendances pour un total de 45 Mo

> Objectifs
ğŸª¶: Image lÃ©gÃ¨re pour la charger plus rapidement
ğŸš€: DÃ©marrage rapide et Rebuild rapide pour ne pas perdre de temps lors du dÃ©veloppement
ğŸ›¡ï¸: Non-root et Sans JDK pour limiter les possibilitÃ©es d'attaques

Next: Screen
*/

## Ã‰cran .[hide-title]

<video></video>

/*
# Dofigen de base:
- CrÃ©ation depuis l'image: eclipse-temurin:17-jdk
- dÃ©finir le rÃ©pertoire de travail: /app
- copie des sources
- En tant que `root`:
-> GÃ©nÃ©ration du jar: ./mvnw package -DskipTests
-> copie du jar gÃ©nÃ©rÃ© en dehors du dossier de build: mv target/*.jar app.jar
- DÃ©finition de la commande de lancement: [java, -jar, app.jar]

Lourde: 280 Mo; Temps rebuild de 25 sec; Contient un JDK
Mais => Non root


!Problem!
cp ../v1/dofigen.yml ./dofigen.yml


dofigen gen
code Dockerfile -r


docker build -t demo:1 .

!lancement!
docker run --rm -dt --name demo -p 8081:8080 demo:1

curl http://localhost:8081/greeting && echo ""

docker stop demo





# RÃ©duction de la taille de l'image
- CrÃ©ation d'un builder "package":
-> utilisation d'une image Maven Alpine: maven:3.9-eclipse-temurin-17-alpine
-> utilisation de la commande `mvn` au lieu du wrapper
- utilisation d'une image JRE et Alpine: eclipse-temurin:17-jre-alpine
- copy du jar gÃ©nÃ©rÃ©

Taille: 280 Mo -> 78 Mo (/3.5)

!Problem!
cp ../v2/dofigen.yml ./dofigen.yml





# Optimisation du temps de build
- restriction du contexte au `pom.xml` et au dossier `src/main`
- cache des dÃ©pendances Maven `/root/.m2` et du cache de build `target`. Obligation de dÃ©placer le JAR gÃ©nÃ©rÃ© en dehors du dossier de build.

Temps rebuild: 25s -> 5s (/5)

!Problem!
cp ../v3/dofigen.yml ./dofigen.yml



*/

## Benchmark .[benchmark]

//@ < 12:00

/*
Ã‰tape par Ã©tape, on a construit notre image Docker pour la rendre Ã©ligible Ã  la production.

Next: Ok, mais il y a quand mÃªme une syntax Ã  apprendre... Dofigen Hub
*/

| DÃ©mo           | Taille      | 1er accÃ¨s | Tps build   | Tps rebuild   | User    | Sans JDK		|
|----------------|-------------|-----------|-------------|---------------|---------|------------|
| v1 Base        | 280 Mo      | 3s ğŸš€     | 25s         | =             | 1000 ğŸ˜· | Non        |
| v2 Tiny Image  | 78 Mo ğŸª¶    | 3s ğŸš€     | 25s         | =             | 1000 ğŸ˜· | Non        |
| v3 Fast Build  | 78 Mo ğŸª¶    | 3s ğŸš€     | 25s         | 5s âŒ›         | 1000 ğŸ˜· | Oui ğŸ›¡ï¸     |


## Dofigen Hub .[steps hub]

Trouvez une configuration Dofigen et adaptez-la Ã  votre cas d'usage !

- Utilisez des confs existantes

    ```yaml
    extend:
      - https://hub.dofigen.io/jvm/maven-jar.image.yml
    copy:
      +:
        content: |
          #!/bin/sh
          java -jar app.jar
        target: /run.sh
        chmod: 555
    cmd: [/run.sh]
    ```
- Ne partez pas de zÃ©ro

    ```yaml
    context:
    - /pom.xml
    - /src/main/
    builders:
      maven-package:
        fromImage: maven:3-eclipse-temurin-17-alpine
        workdir: /app
        root:
          run:
          - mvn package -DskipTests
          - mv target/*.jar /tmp/app.jar
          cache:
          - target: /root/.m2
          - target: target
          bind:
          - target: pom.xml
            source: pom.xml
          - target: src
            source: src
    fromImage: eclipse-temurin:17-jre-alpine
    workdir: /app
    copy:
    - fromBuilder: maven-package
      paths:
      - /tmp/app.jar
      target: app.jar
    - content:|
        #!/bin/sh
        java -jar app.jar
      target: /run.sh
      chmod: 555
    cmd: [/run.sh]
    ```

/*


Next: Dofigen: un projet Open Source
*/

//@ < 14:00

!include(conclusion.sdf)
