## DÃ©monstration .[sbs]

Comprendre par l'exemple

<div class="step" markdown>
### Objectifs

- ğŸª¶: Image lÃ©gÃ¨re
- ğŸš€: DÃ©marrage rapide
- âŒ›: Rebuild rapide
- ğŸ›¡ï¸: Sans JDK
- ğŸ˜·: Utilisateur non-root
</div>

/*
Projet SpringBoot simple
133 dÃ©pendances pour un total de 45 Mo

ğŸª¶: Image lÃ©gÃ¨re pour la charger plus rapidement
ğŸš€: DÃ©marrage rapide pour avoir accÃ¨s 
âŒ›: Rebuild rapide pour ne pas perdre de temps lors du dÃ©veloppement
ğŸ›¡ï¸: Sans JDK pour Ã©viter de permettre de build une classe Java directement
ğŸ˜·: Utilisateur non-root pour limiter les possibilitÃ©es d'attaques
*/

## v0: ğŸ›‘ Le Dockerfile Ã  ne pas faire

```dockerfile
FROM eclipse-temurin:17-jdk
COPY . .
CMD ./mvnw spring-boot:run
```

/*
Plus intuitif
From: image depuis laquelle on part
Copy: copie des fichiers dans l'image
Cmd: commande exÃ©cutÃ©e au dÃ©marrage
*/

## v1: Le Dockerfile de base .[sbs]

/*
On compile le projet avec maven
On renome le jar pour qu'il soit plus facilement accessible
On modifie la commande de dÃ©marrage pour lancer le jar
*/

```dockerfile
FROM eclipse-temurin:17-jdk
COPY . .
RUN ./mvnw clean package -DskipTests
RUN mv target/*.jar app.jar
CMD ["java","-jar","app.jar"]
```

## v1: Le Dockerfile de base .[sbs]

### MÃ©triques

- Taille de l'image: **541 Mo**
- Temps de build initial: **20s**
- Temps de rebuild: **Ã©quivalent**
- Temps de 1er accÃ¨s: **3s**
- Utilisateur: **root**
- PrÃ©cense du JDK: **Oui**

### ProblÃ¨mes

- Image lourde ğŸª¨
- Contient le JDK ğŸ›
- Chargement des libs Ã  chaque build ğŸ“š
- Utilisateur root ğŸ§‘â€ğŸ’»

<div class="step" markdown>
### Du mieux

- AmÃ©lioration du temps de dÃ©marrage ğŸš€
- Plus besoin d'accÃ¨s internet â›“ï¸â€ğŸ’¥
</div>

/*
dÃ©pendances Ã  la compilation => 

AmÃ©lioration du temps de dÃ©marrage
Plus besoin d'accÃ¨s internet
*/

## v2: Tranformation pour Dofigen .[sbs]

```yaml
from: eclipse-temurin:17-jdk
add:
  - "."
root:
  run:
    - ./mvnw clean package -DskipTests
    - mv target/*.jar app.jar
cmd: ["java","-jar","app.jar"]
```

/*
On prend les champs correspondants aux commandes du Dockerfile
Le seul changement est la dÃ©finition de la commande en tant que root, car par dÃ©faut non-root
*/

## v2: Tranformation pour Dofigen .[sbs]

### MÃ©triques

- Taille de l'image: **521 Mo**
- Temps de build initial: **20s**
- Temps de rebuild: **Ã©quivalent**
- Temps de 1er accÃ¨s: **3s**
- Utilisateur: **1000**
- PrÃ©cense du JDK: **Oui**

### ProblÃ¨mes

- Image lourde ğŸª¨
- Contient le JDK ğŸ›
- Chargement des libs Ã  chaque build ğŸ“š

<div class="step" markdown>
### Du mieux

- Utilisateur non-root ğŸ˜·
- On gagne 20 Mo sur l'image ğŸ’‡

/*
Utilisateur non root
20 Mo de moins: pas grand chose, Ã©quivalent Ã  une coupe de cheuveux
C'est dÃ» aux RUN passÃ©s sur une seule commande
*/
</div>

## v3: Optimiser la taille de l'image .[sbs]

```yaml
builders:
  - from: maven:3.9-eclipse-temurin-17-alpine
    add:
      - "."
    root:
      run:
        - mvn clean package -DskipTests
from: eclipse-temurin:17-jre-alpine
artifacts:
  - builder: builder-0
    source: target/*.jar
    target: app.jar
cmd: ["java","-jar","app.jar"]
```

/*
DÃ©finition d'un builder basÃ© sur une image maven alpine (lÃ©gÃ¨re)
Utilisation de maven sans wrapper
Image finale basÃ©e sur JRE alpine
RÃ©cupÃ©ration du JAR en tant qu'artefact depuis le builder
*/

## v3: Optimiser la taille de l'image .[sbs]

### MÃ©triques

- Taille de l'image: **185 Mo**
- Temps de build initial: **20s**
- Temps de rebuild: **Ã©quivalent**
- Temps de 1er accÃ¨s: **3s**
- Utilisateur: **1000**
- PrÃ©cense du JDK: **Non**

### ProblÃ¨mes

- Chargement des libs Ã  chaque build ğŸ“š

<div class="step" markdown>
### Du mieux

- Taille de l'image divisÃ©e par 3,5 ğŸª¶
- Plus de JDK dans l'image finale ğŸ›¡ï¸
</div>

/*
Taille de l'image divisÃ©e par 3,5 ğŸª¶
Plus de JDK dans l'image finale ğŸ›¡ï¸
*/

## v4: Gestion du cache .[sbs]

```yaml
builders:
  - from: maven:3.9-eclipse-temurin-17-alpine
    workdir: /app
    add:
      - "."
    root:
      run:
        - mvn package -DskipTests
        - mv target/*.jar app.jar
      cache:
        - /root/.m2
        - /app/target
from: eclipse-temurin:17-jre-alpine
artifacts:
  - builder: builder-0
    source: /app/app.jar
    target: app.jar
cmd: ["java","-jar","app.jar"]
context:
  - /pom.xml
  - /src/main/
```

/*
Ajout d'un workdir, car le cache est dÃ©fini de maniÃ¨re absolue
DÃ©finition de deux caches:  dÃ©pendances maven + build du projet
DÃ©placement du jar en dehors du dossier target qui est en cache

DÃ©finition du contexte pour ne charger que ce qui est nÃ©cessaire
*/

## v4: Gestion du cache .[sbs]

### MÃ©triques

- Taille de l'image: **185 Mo**
- Temps de build initial: **20s**
- Temps de rebuild: **5s**
- Temps de 1er accÃ¨s: **3s**
- Utilisateur: **1000**
- PrÃ©cense du JDK: **Non**

<div class="step" markdown>
### Du mieux

- Chargement des libs une fois ğŸ’
- Temps de rebuild divisÃ© par 4 âŒ›

/*
Il garde les libs dans le cache, et ne les recharge pas Ã  chaque build
*/
</div>