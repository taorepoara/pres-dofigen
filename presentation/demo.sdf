## DÃ©monstration

Comprendre par l'exemple

/*
Projet SpringBoot simple
X dÃ©pendances pour un total de X Mo
*/

## v0: ğŸ›‘ Le Dockerfile Ã  ne pas faire .[sbs]

```dockerfile
FROM eclipse-temurin:17-jdk
COPY . .
CMD ./mvnw spring-boot:run
```

/*
export num=0
./build.sh

docker run --rm -it -p 8080:8080 devquest-${num}

http://localhost:8080/greeting

./stats.sh

*/

## v0: ğŸ›‘ Le Dockerfile Ã  ne pas faire .[sbs]

<div class="step">

### MÃ©triques

- Temps de build initial: **1s**
- Temps de re-build: **Ã©quivalent**
- Taille de l'image: **427M**
- Utilisateur: **root**
</div>

<div class="step">

### ProblÃ¨mes

- Chargement des libs au dÃ©marrage ğŸŒ
- besoin d'internet pour dÃ©marrer ğŸŒ
- Image lourde ğŸª¨
- Contient le JDK ğŸ›
- Utilisateur root ğŸ§‘â€ğŸ’»
</div>


## v1: Le Dockerfile de base .[sbs]

/*
export num=1
./build.sh

docker run --rm -it -p 8080:8080 devquest-${num}

./stats.sh
*/

```dockerfile
FROM eclipse-temurin:17-jdk
COPY . .
RUN ./mvnw clean package -DskipTests
RUN mv target/ *.jar app.jar
CMD ["java","-jar","app.jar"]
```

## v1: Le Dockerfile de base .[sbs]

<div class="step">

### MÃ©triques

- Temps de build initial: **20s**
- Temps de re-build: **Ã©quivalent**
- Taille de l'image: **541M**
- Utilisateur: **root**

/*
DÃ©pend de la vitesse de connexion, car c'est le chargement des libs qui prends du temps
*/

</div>

<div class="step">

### ProblÃ¨mes

- Image lourde ğŸª¨
- Contient le JDK ğŸ›
- Chargement des libs Ã  chaque build ğŸ“š
- Utilisateur root ğŸ§‘â€ğŸ’»
</div>

<div class="step">

### Du mieux

- AmÃ©lioration du temps de dÃ©marrage ğŸš€
- Plus besoin d'accÃ¨s internet â›“ï¸â€ğŸ’¥
</div>

## v2: Tranformation pour Dofigen .[sbs]

```yaml
from: eclipse-temurin:17-jdk
add:
  - "."
root:
  run:
    - ./mvnw clean package -DskipTests
    - mv target/ *.jar app.jar
cmd: ["java","-jar","app.jar"]
```

/*
export num=2
./build.sh

docker run --rm -it -p 8080:8080 devquest-${num}

./stats.sh
*/

## v2: Tranformation pour Dofigen .[sbs]

<div class="step">

### MÃ©triques

- Temps de build initial: **20s**
- Temps de re-build: **Ã©quivalent**
- Taille de l'image: **521M**
- Utilisateur: **1000**
</div>

<div class="step">

### ProblÃ¨mes

- Image lourde ğŸª¨
- Contient le JDK ğŸ›
- Chargement des libs Ã  chaque build ğŸ“š
</div>

<div class="step">

### Du mieux

- Utilisateur non-root ğŸ˜·
- On gagne 20M sur l'image ğŸ’‡

/*
20 Mo de moins, c'est pas beaucoup, mais c'est dÃ©jÃ  Ã§a
C'est dÃ» aux RUN passÃ©s sur une seule commande
*/

</div>

## v3: Optimiser la taille de l'image .[sbs]

```yaml
builders:
  - from: maven:3.9-eclipse-temurin-17-alpine
    add:
      - "."
    root:
      run:
        - mvn clean package -DskipTests
from: eclipse-temurin:17-jre-alpine
artifacts:
  - builder: builder-0
    source: target/ *.jar
    target: app.jar
cmd: ["java","-jar","app.jar"]
```

/*
export num=3
./build.sh

docker run --rm -it -p 8080:8080 devquest-${num}

./stats.sh
*/

## v3: Optimiser la taille de l'image .[sbs]

<div class="step">

### MÃ©triques
- Temps de build initial: **20s**
- Temps de re-build: **Ã©quivalent**
- Taille de l'image: **185M**
- Utilisateur: **1000**
</div>

<div class="step">

### ProblÃ¨mes

- Chargement des libs Ã  chaque build ğŸ“š
</div>

<div class="step">

### Du mieux

- Taille de l'image divisÃ©e par 3,5 ğŸª¶
- Plus de JDK dans l'image finale ğŸ›¡ï¸
</div>

## v4: Gestion du cache .[sbs]

```yaml
builders:
  - from: maven:3.9-eclipse-temurin-17-alpine
    workdir: /app
    add:
      - "."
    root:
      run:
        - mvn package -DskipTests
        - mv target/ *.jar app.jar
      cache:
        - /root/.m2
        - /app/target
from: eclipse-temurin:17-jre-alpine
artifacts:
  - builder: builder-0
    source: /app/app.jar
    target: app.jar
cmd: ["java","-jar","app.jar"]
context:
  - /pom.xml
  - /src/main/
```

/*
export num=4
./build.sh

docker run --rm -it -p 8080:8080 devquest-${num}

./stats.sh
*/

## v4: Gestion du cache .[sbs]

<div class="step">

### MÃ©triques

- Temps de build initial: **20s**
- Temps de re-build: **5s**
- Taille de l'image: **185M**
- Utilisateur: **1000**
</div>

<div class="step">

### Du mieux

- Chargement des libs une fois ğŸ’
- Temps de re-build divisÃ© par 4 âŒ›

/*
Il garde les libs dans le cache, et ne les recharge pas Ã  chaque build
*/
</div>

## v4: Gestion du cache .[sbs]

```dockerfile
# syntax=docker/dockerfile:1.4
# builder-0
FROM maven:3.9-eclipse-temurin-17-alpine AS builder-0
WORKDIR /app
ADD --link . ./
USER 0
RUN \
    --mount=type=cache,sharing=locked,uid=0,gid=0,target=/root/.m2\
    --mount=type=cache,sharing=locked,uid=0,gid=0,target=/app/target\
    mvn package -DskipTests && \
    mv target/ *.jar app.jar
# runtime
FROM eclipse-temurin:17-jre-alpine AS runtime
COPY --link --chown=1000:1000 --from=builder-0 "/app/app.jar" "app.jar"
USER 1000
CMD ["java","-jar","app.jar"]
```
